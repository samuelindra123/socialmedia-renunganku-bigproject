generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"

}

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  namaLengkap       String
  password          String
  isEmailVerified   Boolean   @default(false)
  verificationToken String?
  verificationOtp   String?
  otpExpiry         DateTime?
  
  profile           Profile?
  posts             Post[]
  bookmarks         Bookmark[]
  mentions          Mention[]
  likes             Like[]
  comments          Comment[]
  followers         Follow[]         @relation("UserFollowers")
  following         Follow[]         @relation("UserFollowing")
  notifications     Notification[]   @relation("UserNotifications")
  sentNotifications Notification[]   @relation("NotificationActor")
  interactions      UserInteraction[] @relation("UserInteractions")
  targetedBy        UserInteraction[] @relation("TargetInteractions")
  stories           Story[]
  storyViews        StoryView[]
  conversations     ConversationParticipant[]
  messages          Message[]
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model Profile {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  username        String   @unique
  profileImageUrl String?
  umur            Int
  tanggalLahir    DateTime
  tempatKelahiran String
  
  isOnboardingComplete Boolean @default(false)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Post {
  id        String   @id @default(uuid())
  content   String   // Caption/text
  authorId  String
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  
  images    PostImage[]
  bookmarks Bookmark[]
  hashtags  PostHashtag[]
  mentions  Mention[]
  likes     Like[]
  comments  Comment[]
  engagement PostEngagement?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PostImage {
  id        String   @id @default(uuid())
  url       String
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
}

model Bookmark {
  id        String   @id @default(uuid())
  userId    String
  postId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
}

model Hashtag {
  id        String   @id @default(uuid())
  name      String   @unique
  postCount Int      @default(0)
  
  posts     PostHashtag[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([name])
}

model PostHashtag {
  id        String  @id @default(uuid())
  postId    String
  hashtagId String
  post      Post    @relation(fields: [postId], references: [id], onDelete: Cascade)
  hashtag   Hashtag @relation(fields: [hashtagId], references: [id], onDelete: Cascade)
  
  @@unique([postId, hashtagId])
}

model Mention {
  id        String   @id @default(uuid())
  postId    String
  userId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([postId, userId])
  @@index([userId])
}

model Like {
  id        String   @id @default(uuid())
  userId    String
  postId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
}

model Comment {
  id        String    @id @default(uuid())
  content   String
  userId    String
  postId    String
  parentId  String?
  
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentReplies")
  
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  @@index([postId])
  @@index([userId])
  @@index([parentId])
}

model Follow {
  id          String   @id @default(uuid())
  followerId  String
  followingId String
  
  follower    User     @relation("UserFollowers", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("UserFollowing", fields: [followingId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  
  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model Notification {
  id         String           @id @default(uuid())
  userId     String
  type       NotificationType
  title      String
  message    String
  actionUrl  String?
  isRead     Boolean          @default(false)
  
  actorId    String?
  actor      User?            @relation("NotificationActor", fields: [actorId], references: [id], onDelete: Cascade)
  user       User             @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt  DateTime         @default(now())
  
  @@index([userId])
  @@index([isRead])
}

enum NotificationType {
  LIKE
  COMMENT
  FOLLOW
  MENTION
}

model PostEngagement {
  id              String   @id @default(uuid())
  postId          String   @unique
  post            Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  viewCount       Int      @default(0)
  likeCount       Int      @default(0)
  commentCount    Int      @default(0)
  shareCount      Int      @default(0)
  bookmarkCount   Int      @default(0)
  
  engagementScore Float    @default(0)
  
  updatedAt       DateTime @updatedAt
  
  @@index([engagementScore])
}

model UserInteraction {
  id            String   @id @default(uuid())
  userId        String
  targetUserId  String
  user          User     @relation("UserInteractions", fields: [userId], references: [id], onDelete: Cascade)
  targetUser    User     @relation("TargetInteractions", fields: [targetUserId], references: [id], onDelete: Cascade)
  
  affinityScore Float    @default(0)
  
  updatedAt     DateTime @updatedAt
  
  @@unique([userId, targetUserId])
  @@index([userId])
  @@index([affinityScore])
}

model Story {
  id        String          @id @default(uuid())
  userId    String
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  mediaUrl  String
  mediaType StoryMediaType
  caption   String?
  
  expiresAt DateTime
  
  views     StoryView[]
  
  createdAt DateTime        @default(now())
  
  @@index([userId])
  @@index([expiresAt])
}

model StoryView {
  id        String   @id @default(uuid())
  storyId   String
  userId    String
  story     Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  viewedAt  DateTime @default(now())
  
  @@unique([storyId, userId])
  @@index([storyId])
  @@index([userId])
}

enum StoryMediaType {
  IMAGE
  VIDEO
}

model Conversation {
  id            String                    @id @default(uuid())
  isGroup       Boolean                   @default(false)
  name          String?
  
  participants  ConversationParticipant[]
  messages      Message[]
  
  lastMessageAt DateTime?
  createdAt     DateTime                  @default(now())
  updatedAt     DateTime                  @updatedAt
  
  @@index([lastMessageAt])
}

model ConversationParticipant {
  id             String       @id @default(uuid())
  conversationId String
  userId         String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  lastReadAt     DateTime?
  joinedAt       DateTime     @default(now())
  
  @@unique([conversationId, userId])
  @@index([userId])
}

model Message {
  id             String       @id @default(uuid())
  conversationId String
  senderId       String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation(fields: [senderId], references: [id], onDelete: Cascade)
  
  content        String
  mediaUrl       String?
  messageType    MessageType  @default(TEXT)
  
  isEdited       Boolean      @default(false)
  isDeleted      Boolean      @default(false)
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
}

enum MessageType {
  TEXT
  IMAGE
  VIDEO
  FILE
}
